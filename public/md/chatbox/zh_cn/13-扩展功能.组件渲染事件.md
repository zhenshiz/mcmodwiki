<h2 id="r" data-toc-id="r">RenderEvents 组件渲染事件</h2>
<p>组件渲染事件是一个高级功能，指在对话播放过程中，会在组件渲染的特定时机触发一些自定义的事件效果，比如播放音效，执行指令，隐藏或显示特定组件等。</p>
<p><code>renderEvents</code>可以作为对话的参数，也可以定义在任意组件下。若作为对话的参数，则仅会在跳转到该句对话时触发事件。</p>
<p>先来看一个让选项在对话框文本显示完毕后才出现的配置（主题文件中）：</p><pre language="json" isclosed="false"><code class="language-json">  "option": {
    "texture": "chatbox:textures/options/default_no_checked_option.png",
    "selectTexture": "chatbox:textures/options/default_checked_option.png",
    "lockTexture": "chatbox:textures/options/default_lock_checked_option.png",
    "x": 0, "y": 30, "width": 35, "height": 8, "alignX": "right", "alignY": "top",
    "optionChatX": 6, "optionChatY": 2.7, "textAlign": "left",
    "hidden": true,
    "注释": "这里的hidden只是在渲染层面隐藏选项，用于让选项不在一开始就显示出来，以配合对话框的事件"
  },
  "dialogBox": {
    "texture": "chatbox:textures/chatbox/default_dialog_box.png",
    "alignX": "left", "alignY": "bottom", "lineWidth": 70, "width": 100, "height": 40,
    "nameX": 20, "nameY": 10, "textX": 20, "textY": 15,
    "renderEvents": [
      {"trigger": "end", "type": "show", "value": "@Options"}
    ]
  }</code></pre>
<p>组件渲染事件也是一个数组，每个事件包含3个字段：</p>
<ul>
  <li>
    <p><code>trigger</code>：触发事件的时机，包括以下几种：</p>
    <ul>
      <li>
        <p><code>on_start</code>（可简写为<code>start</code>）：组件渲染开始时触发（或者跳转到对话时）。
        </p>
      </li>
      <li>
        <p><code>on_end</code>（可简写为<code>end</code>）：组件渲染结束时触发。</p>
      </li>
    </ul>
  </li>
</ul>
<div type="info" data-type="admonition" data-admo-type="info">
  <div data-type="admonition-title">INFO</div>
  <div data-type="admonition-content">
    <p>
      对于<code>dialogBox</code>组件，会在文本显示完毕时触发；对于<code>portrait</code>组件，若其有动画且不循环播放，则会在立绘动画结束时触发；对于<code>video</code>组件，若其不循环播放，则会在视频播放结束时触发。其他组件没有这个时机。
    </p>
  </div>
</div>
<ul>
  <li>
    <p><strong>以下三个触发时机仅针对</strong><code>portrait</code><strong>立绘组件：</strong>
    </p>
    <ul>
      <li>
        <p>
          <code>on_click</code>（可简写为<code>click</code>）：立绘被点击时触发。（若立绘重叠，则仅会执行最上层立绘的该类事件）
        </p>
      </li>
      <li>
        <p><code>on_mouse_over</code>（可简写为<code>mouse_over</code>）：鼠标悬停在立绘上时触发。
        </p>
      </li>
      <li>
        <p><code>on_mouse_out</code>（可简写为<code>mouse_out</code>）：鼠标从立绘上移走时触发。
        </p>
      </li>
    </ul>
  </li>
</ul>
<p></p>
<ul>
  <li>
    <p><code>type</code>：事件类型，内置多种事件且支持用kjs注册自定义的类型（见本文末尾）。</p>
  </li>
  <li>
    <p><code>value</code>：事件参数，根据事件类型的不同，参数的内容也不同。内置事件类型和参数介绍：</p>
    <ul>
      <li>
        <p><code>command</code>：服务端执行指令。参数填指令（无需加<code>/</code>）。</p>
      </li>
      <li>
        <p>
          <code>jump</code>：强制跳转对话，无视限制。不填参数则默认跳转下一句对话；填数字则跳转至指定索引对话；填组名则跳转至该组的第一句对话；<strong>填</strong><code>this</code><strong>会留在当前对话；填负数会结束对话</strong>。
        </p>
      </li>
      <li>
        <p><code>goto_next</code>：到下一句对话，若有选项在则无效。无参数。</p>
      </li>
      <li>
        <p>
          <code>play_sound</code>：播放音效。参数填音效id（比如<code>minecraft:ambient.cave</code>）。
        </p>
      </li>
      <li>
        <p>
          <code>play_voice</code>：播放语音。同播放音效，区别是通过这个事件播放的音效类似于galgame的语音播放机制，进入下一句对话就会停止。
        </p>
      </li>
      <li>
        <p><code>stop_sound</code>：停止特定音效。</p>
      </li>
      <li>
        <p>
          <code>hide</code>：隐藏特定组件，可以用<code>;</code>隔开多个组件。若参数以<code>@</code>开头则隐藏所有相关组件，否则隐藏指定id的立绘。<code>@s</code>指向组件本身，<code>@portraits</code>指向所有立绘，<code>@options</code>指向所有选项，<code>@buttons</code>指向所有按键，<code>@dialog</code>指向文本框，<code>@video</code>指向视频。
        </p>
      </li>
      <li>
        <p><code>show</code>：显示特定组件。参数写法同上。</p>
      </li>
      <li>
        <p><code>replace</code>：替换自身为特定组件。就是先隐藏自己，再显示别的组件的简单写法，参数写法同上。</p>
      </li>
      <li>
        <p>
          <code>set_autoplay</code>：设置是否自动播放。参数填<code>true</code>或<code>false</code>。
        </p>
      </li>
      <li>
        <p><code>scale</code>：缩放立绘。参数填缩放比例（float类型）。</p>
      </li>
      <li>
        <p><code>play_animation</code>：播放一个动画。参数只能填主题文件预设的动画名称。</p>
      </li>
      <li>
        <p><code>restart_animation</code>：重新播放该立绘拥有的动画，对于循环播放动画的立绘无效果。无参数。</p>
      </li>
    </ul>
  </li>
</ul>
<div type="important" data-type="admonition" data-admo-type="important">
  <div data-type="admonition-title">IMPORTANT</div>
  <div data-type="admonition-content">
    <p>
      需要注意的是，若组件因<code>hide</code>事件或组件的<code>hidden</code>字段为<code>true</code>被隐藏了，那个组件将不会被渲染、不可互动，自然也不可触发渲染事件。<br>立绘必须在一句对话的<code>portrait</code>数组中被提及（或者因之前的对话保留）才可显示或隐藏，<strong>无法通过事件添加一个新的立绘到当前的对话中!</strong>
    </p>
  </div>
</div>
<p></p>
<p>示例：添加两个立绘，开始时只显示其中一个，点击立绘切换成另一个，再次点击又切换回来（对话文件中，使用了两种不同的写法）。</p><pre language="json" isclosed="false"><code class="language-json">{
  "renderEvents": [
    {"trigger": "start", "type": "hide", "value": "portrait2"}
  ],
  "注释": "如果 portrait2 的 hidden 字段被设置为 true ，就无需上面的 hide 事件",
  "portrait": [
    {
      "id": "portrait1",
      "renderEvents": [
        {"trigger": "click", "type": "hide", "value": "@s"},
        {"trigger": "click", "type": "show", "value": "portrait2"}
      ]
    },
    {
      "id": "portrait2",
      "renderEvents": [
        {"trigger": "click", "type": "replace", "value": "portrait1"}
      ]
    }
  ]
}</code></pre>
<h3 id="使用kubejs自定义新的事件类型" data-toc-id="使用kubejs自定义新的事件类型">使用KubeJS自定义新的事件类型
</h3><pre language="javascript" isclosed="false"><code class="language-javascript">//server_script

//你可以在服务端任意事件中添加对话组件渲染事件，比如我这里用的是服务端载入事件 
ServerEvents.loaded(event =&gt; {
  //第一个参数是事件的类型，是你选项写渲染事件type的值，无视大小写
  //第二个参数是事件触发时，在客户端执行的操作
  //第三个参数是决定是否需要在服务端执行操作，如果填true就会自动发包触发第四个参数里的内容
  //第四个参数是事件触发时，在服务端执行的操作
  ChatBoxUtil.registerComponentEvent(
          'test',
          // 此处lambda表达式的第一个参数为触发事件的组件，可能为空，要使用一定记得检查！第二个参数为事件的参数
          (component, value) =&gt; { },
          true,
          (player, value) =&gt; {
            player.tell('test click')
            // 可以在此处使用ChatBoxUtil.serverGetChatTargets(player)来获取当前对话的目标实体列表
            let targets = ChatBoxUtil.serverGetChatTargets(player)
            if (targets.length &gt; 0) {
              let target = targets[0]
              player.tell('target1: ' + target.getName().getString())
            }
          })
})</code></pre>
<p></p>
<div type="info" data-type="admonition" data-admo-type="info">
  <div data-type="admonition-title">你知道吗</div>
  <div data-type="admonition-content">
    <ol>
      <li>
        <p>组件渲染事件一开始只是选项点击事件，而选项点击事件最早只有执行命令的效果。</p>
      </li>
      <li>
        <p>
          选项其实就是自带几个便捷参数的立绘，只要你愿意写，立绘也完全能当作选项。因为选项的点击事件其实就是触发时机为<code>click</code>的组件渲染事件，选项跳转对话也就是<code>jump</code>类型的组件渲染事件。
        </p>
      </li>
    </ol>
  </div>
</div>
<p></p>